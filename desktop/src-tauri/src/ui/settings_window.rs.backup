// Native Settings Window Implementation
// This provides the settings window functionality for TunnelForge

use tauri::{AppHandle, Manager, Window, WindowBuilder, LogicalSize, LogicalPosition};
use serde::{Serialize, Deserialize};

#[derive(Serialize, Deserialize, Clone, Debug)]
pub struct SettingsConfig {
    pub autostart: bool,
    pub show_in_dock: bool,
    pub prevent_sleep: bool,
    pub server_port: String,
    pub access_mode: String,
    pub notifications_enabled: bool,
    pub notification_sound: bool,
    pub show_in_notification_center: bool,
    pub notification_session_start: bool,
    pub notification_session_exit: bool,
    pub notification_command_error: bool,
    pub notification_command_completion: bool,
    pub notification_bell: bool,
    pub notification_claude_turn: bool,
    pub tailscale_enabled: bool,
    pub cloudflare_enabled: bool,
    pub ngrok_enabled: bool,
    pub ngrok_auth_token: String,
}

impl Default for SettingsConfig {
    fn default() -> Self {
        Self {
            autostart: false,
            show_in_dock: true,
            prevent_sleep: true,
            server_port: "4020".to_string(),
            access_mode: "localhost".to_string(),
            notifications_enabled: true,
            notification_sound: true,
            show_in_notification_center: true,
            notification_session_start: true,
            notification_session_exit: true,
            notification_command_error: true,
            notification_command_completion: false,
            notification_bell: false,
            notification_claude_turn: false,
            tailscale_enabled: false,
            cloudflare_enabled: false,
            ngrok_enabled: false,
            ngrok_auth_token: "".to_string(),
        }
    }
}

#[derive(Clone)]
pub struct SettingsWindow {
    window: Option<Window>,
}

impl SettingsWindow {
    pub fn new() -> Self {
        Self { window: None }
    }

    pub fn create_window(&mut self, app_handle: &AppHandle) -> Result<(), String> {
        let window = WindowBuilder::new(
            app_handle,
            "settings",
            
        )
        .title("TunnelForge Settings")
        .inner_size(600.0, 700.0)
        .min_inner_size(500.0, 600.0)
        .center()
        .build()
        .map_err(|e| format!("Failed to create settings window: {}", e))?;

        self.window = Some(window);
        Ok(())
    }

    pub fn show(&self) -> Result<(), String> {
        if let Some(window) = &self.window {
            window.show()
                .map_err(|e| format!("Failed to show settings window: {}", e))?;
            window.set_focus()
                .map_err(|e| format!("Failed to focus settings window: {}", e))?;
        }
        Ok(())
    }

    pub fn hide(&self) -> Result<(), String> {
        if let Some(window) = &self.window {
            window.hide()
                .map_err(|e| format!("Failed to hide settings window: {}", e))?;
        }
        Ok(())
    }

    pub fn close(&mut self) -> Result<(), String> {
        if let Some(window) = &self.window {
            window.close()
                .map_err(|e| format!("Failed to close settings window: {}", e))?;
        }
        self.window = None;
        Ok(())
    }

    pub fn is_visible(&self) -> bool {
        if let Some(window) = &self.window {
            window.is_visible().unwrap_or(false)
        } else {
            false
        }
    }
}

// Tauri commands for settings window management
#[tauri::command]
pub async fn show_settings_window(app_handle: AppHandle) -> Result<(), String> {
    let settings_window = app_handle.state::<SettingsWindow>();
    let mut settings_window = settings_window.inner().clone();
    
    if settings_window.window.is_none() {
        settings_window.create_window(&app_handle)?;
    }
    
    settings_window.show()
}

#[tauri::command]
pub async fn hide_settings_window(app_handle: AppHandle) -> Result<(), String> {
    let settings_window = app_handle.state::<SettingsWindow>();
    let settings_window = settings_window.inner();
    settings_window.hide()
}

#[tauri::command]
pub async fn close_settings_window(app_handle: AppHandle) -> Result<(), String> {
    let settings_window = app_handle.state::<SettingsWindow>();
    let mut settings_window = settings_window.inner().clone();
    settings_window.close()
}

#[tauri::command]
pub async fn get_settings_window_state(app_handle: AppHandle) -> Result<bool, String> {
    let settings_window = app_handle.state::<SettingsWindow>();
    let settings_window = settings_window.inner();
    Ok(settings_window.is_visible())
}

#[tauri::command]
pub async fn update_settings_window_state(app_handle: AppHandle, visible: bool) -> Result<(), String> {
    let settings_window = app_handle.state::<SettingsWindow>();
    let mut settings_window = settings_window.inner().clone();
    
    if visible {
        if settings_window.window.is_none() {
            settings_window.create_window(&app_handle)?;
        }
        settings_window.show()
    } else {
        settings_window.hide()
    }
}

// Settings configuration commands
#[tauri::command]
pub async fn get_settings_config(app_handle: AppHandle) -> Result<SettingsConfig, String> {
    // TODO: Load from persistent storage
    Ok(SettingsConfig::default())
}

#[tauri::command]
pub async fn save_settings_config(app_handle: AppHandle, config: SettingsConfig) -> Result<(), String> {
    // TODO: Save to persistent storage
    println!("Saving settings config: {:?}", config);
    Ok(())
}

#[tauri::command]

#[tauri::command]

#[tauri::command]


// Service integration commands
#[tauri::command]
pub async fn toggle_tailscale_integration(app_handle: AppHandle, enabled: bool) -> Result<(), String> {
    // TODO: Enable/disable Tailscale integration
    println!("Setting Tailscale integration to: {}", enabled);
    Ok(())
}

#[tauri::command]
pub async fn toggle_cloudflare_integration(app_handle: AppHandle, enabled: bool) -> Result<(), String> {
    // TODO: Enable/disable Cloudflare integration
    println!("Setting Cloudflare integration to: {}", enabled);
    Ok(())
}

#[tauri::command]
pub async fn toggle_ngrok_integration(app_handle: AppHandle, enabled: bool) -> Result<(), String> {
    // TODO: Enable/disable ngrok integration
    println!("Setting ngrok integration to: {}", enabled);
    Ok(())
}

#[tauri::command]
pub async fn set_ngrok_auth_token(app_handle: AppHandle, token: String) -> Result<(), String> {
    // TODO: Save ngrok auth token securely
    println!("Setting ngrok auth token");
    Ok(())
}
